## HdpH Makefile
##
## ARCH: i386
## MPI: OpenMPI
## GHC: 6.12.3

## To load HdpH programs into GHCi:
## $> make MP/libwrap_mpi.so
## $> ghci -ilib -LMP:/path/to/OpenMPI/lib -lmpi -lwrap_mpi TEST/HdpH/...

## To run HdpH programs:
## $> make TEST/HdpH/...
## $> mpiexec -x LD_LIBRARY_PATH=MP -n ... TEST/HdpH/...

# GHC environment (version 6.12.3)
HC=ghc-6.12.3
HLIBDIR=lib  ## some libraries from Hackage, installed locally
HCFLAGS=-threaded -cpp -O2
#HCFLAGS=-threaded -cpp -O0 -DHDPH_DEBUG

# OpenMPI environment (locally installed version 1.4.3)
CC=mpicc
CLIBS=-lmpi -lwrap_mpi
CLIBPATH=MP:/path/to/OpenMPI/lib

# C compiler flags
CFLAGS=-Wall -fPIC -O3
#CFLAGS=-Wall -fPIC -DMPI_DEBUG

SRC=$(shell find TEST -name '*.hs' -o -name '*.lhs')
EXE=$(basename $(SRC))
MPLIB=MP/libwrap_mpi.so

.PHONY: default all clean emacsclean distclean

default: 
	echo "No default target"

all: $(EXE)

clean:
	rm -f $(EXE) $(MPLIB) $$(find . -name '*.o' -o -name '*.hi')

emacsclean:
	rm -f $$(find . -name '*~')

distclean: clean emacsclean

%.o: %.hs
	$(HC) $(HCFLAGS) -i$(HLIBDIR) --make $<

%.o: %.lhs
	$(HC) $(HCFLAGS) -i$(HLIBDIR) --make $<

TEST/MP/%: TEST/MP/%.hs $(MPLIB)
	$(HC) $(HCFLAGS) -i$(HLIBDIR) -L$(CLIBPATH) $(CLIBS) --make $<

TEST/HdpH/%: TEST/HdpH/%.hs $(MPLIB)
	$(HC) $(HCFLAGS) -i$(HLIBDIR) -L$(CLIBPATH) $(CLIBS) --make $<

TEST/HdpH_IO/%: TEST/HdpH_IO/%.hs $(MPLIB)
	$(HC) $(HCFLAGS) -i$(HLIBDIR) -L$(CLIBPATH) $(CLIBS) --make $<

# This rule must be last of all 'TEST' rules
TEST/%: TEST/%.hs
	$(HC) $(HCFLAGS) -i$(HLIBDIR) --make $<

MP/libwrap_mpi.so: MP/wrap_mpi.o
	cd MP; $(CC) -shared -o libwrap_mpi.so wrap_mpi.o

MP/wrap_mpi.o: MP/wrap_mpi.c MP/wrap_mpi.h
	cd MP; $(CC) $(CFLAGS) -c wrap_mpi.c
